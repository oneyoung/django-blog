{% extends "admin/base.html" %}

{% load static from staticfiles %}

{% block title %} Post Blog {% endblock %}

{% block head %}
<style type="text/css">
#id_title, table, textarea {
  width: 100%;
}

#id_submit {
  float: right;
}

#id_submit_choices button {
  width: 100%;
}

#id_table_tag td {
  width: 50%;
}

.image img {
  height: 100px;
}

</style>
{% endblock %}

{% block content %}
{% load bootstrap_toolkit %}
<form action="/admin/edit/?pk={{ pk }}" method="post" id="id_form_post">
  {% csrf_token %}
  <table>
    <tr><td>
      <div><input name="title" type="text" id="id_title" maxlength="255"{% if not blog.title %} placeholder="Input your tilte here"{% else %}value="{{ blog.title }}"{% endif %} /></div>
    </td><tr>
    <tr><td>
      <div><textarea name="body_raw" id="id_body_raw" rows=30 placeholder="Content of your blog">{% if blog.body_raw %}{{ blog.body_raw }}{% endif %}</textarea></div>
      <div id="id_uploadimg" style="display:none">
        <div id="id_images">
          <div class="image" style="display:none">
            <img />
            <div class="progress progress-strip active">
              <div class="bar" style="width: 0%"></div>
            </div>
          </div>
        </div>
        <input type="file" multiple />
      </div>
    </td><tr>
    <tr><td>
      {% for format in blog.RAW_FORMAT_CHOICES %}
      <label class="radio">
          <input type="radio" name="raw_format" value="{{ format.0 }}" {% if blog.raw_format == format.0 %}checked{% endif %}>{{ format.1 }}</input>
      </label>
      {% endfor %}
    </td><tr>
    <tr><td>
      <input name="tags" type="hidden" value="" />
      <div class="btn-group" id="id_submit">
        <button class="btn dropdown-toggle" data-toggle="dropdown">
          <span class="caret"></span>
        </button>
        <ul class="dropdown-menu" id="id_submit_choices">
          <li><button type="submit" name="status" value="public" class="btn btn-success">Post to Public</button></li>
          <li><button type="submit" name="status" value="draft" class="btn">Save as Draft</button></li>
          <li><button type="submit" name="status" value="private" class="btn btn-info">Private Only </button></li>
          <li><button type="submit" name="status" value="delete" class="btn btn-danger">Delete!</button></li>
        </ul>
      </div>
    </td><tr>
  </table>
</form>

<input type="file" id="id_fromfile" />

<div id="id_table_tag">
      <input type="text" id="id_txt_tag" data-provide="typeahead" data-source='[{% for tag in tags %}"{{ tag }}",{% endfor %}""]' />
      <button class="btn" id="id_btn_addtag">Add</button>
      <div id="id_taglist">
      {% for tag in tags %}
        <span data-type="tag" class="label {% if blog.id and tag in blog.tags.all %} label-success{% endif %}" id="id_tag_{{ tag.name }}">{{ tag.name }}</span>
      {% endfor %}
      </div>
</div>


{% endblock %}

{% block src %}
  <link rel="stylesheet" type="text/css" href="{% static "plugins/bootstrap/wysihtml5/bootstrap-wysihtml5-0.0.2.css" %}" />
  <script src="{% static "plugins/wysihtml5-0.3.0.min.js" %}"></script>
  <script src="{% static "plugins/bootstrap/wysihtml5/bootstrap-wysihtml5-0.0.2.min.js" %}"></script>

<script>
var selectedFlag = "label-success";

$('#id_taglist').delegate('span', 'click', function() {
  $(this).toggleClass(selectedFlag);
});

function addTag() {
  var name = $('#id_txt_tag').val();
  if (name) {
    var tag = $("#id_tag_" + name);
    if (tag.length) {
      tag.addClass(selectedFlag);
    } else {
      $('<span data-type="tag" class="label label-success" id="id_tag_#name">#name</span>'.replace(/#name/g, name)).appendTo("#id_taglist");
    }
    $('#id_txt_tag').val('');
  }
}

$('#id_txt_tag').keypress(function(e) {
  var code = (e.keyCode ? e.keyCode : e.which);
  if (code == 13) {
    addTag()
  }
});

$('#id_btn_addtag').click(addTag);

$("#id_form_post").submit(function () {
  $(this).find('input[name="title"], input[name="body_raw"]').each(function () {
    if (!$(this).val()) {
      alert("Title and Content must not be blank!");
      return false;
    }
  });
  var tags = $("#id_taglist").find("." + selectedFlag).map(function() {
    return $(this).text();
  });
  $(this).find('input[name="tags"]').each(function () {
    $(this).val(JSON.stringify($.extend(true, [], tags)));
  });
  return true;
});

function wysihtml5Load(load) {
  if (load) {
    $("#id_body_raw").wysihtml5({
      "html": true,
      "color": true,
      "stylesheets": ["{% static "plugins/bootstrap/wysihtml5/wysiwyg-color.css" %}"],
    });
  } else {
    textarea = $('#id_body_raw');
    textarea.siblings("*").each(function () {
      $(this).remove();
    });
    textarea.css('display', '');
  }
}

function albumLoad(load) {
  if (load) {
    $('#id_uploadimg').css('display', '');
    $('#id_uploadimg input').change(function() {
      $(this.files).map(function() {
        console.info(this);
        var type = /image\/.*/i;
        if (type.test(this.type)) {
          /* display upload file */
          var reader = new FileReader();
          var imgdiv = $('#id_uploadimg .image:first-child').clone();
          var imgtag = $(imgdiv.find('img')[0]);
          reader.onload = function(e) {
            imgtag = $(imgdiv.find('img')[0]);
            imgtag.attr('src', e.target.result);
            imgtag.attr('alt', this.name);
            imgdiv.css('display', '');
            imgdiv.appendTo('#id_images');
          };
          reader.readAsDataURL(this);

          /* upload file */
          var xhr = new XMLHttpRequest();
          xhr.fname = this.name;
          if (xhr.upload) {
            xhr.upload.onprogress = function (e) {
              var bar = $(imgdiv.find('.progress .bar')[0]);
              var percentage = Math.floor((e.loaded/e.total*1000)/10) + '%';
              bar.css('width', percentage);
            };
          }
          xhr.onloadend = function(e) {
            if (xhr.status == 200) { /* ajax success */
              resp = JSON.parse(xhr.response)[xhr.fname];
              if (resp['status']) { /* upload success */
                imgtag.attr('data-id', resp['idx']);
              }
            }
          };
          xhr.open('post', '{% url uploadimg %}', true);
          var fd = new FormData;
          fd.append(xhr.fname, this);
          xhr.send(fd);
        } else {
          alert(this.name + " is not an image file.");
        }
      });
    })
  } else {
    $('#id_uploadimg').css('display', 'none');
  }
}

$('#id_form_post input:radio').change(function() {
  var type = $(this).val();
  if (type == "html") {
    wysihtml5Load(true);
  } else {
    wysihtml5Load(false);
  }

  if (type == "album") {
    albumLoad(true);
  }
});

window.onload = function () {
  /* Submit Button */
  $('#id_submit').prepend($('#id_submit_choices button[value="{{ blog.status }}"]').detach());
  /* bootstrap-wysihtml5 */
  if ($('#id_form_post input:checked').val() == "html") {
    wysihtml5Load(true);
  }
};

$('#id_fromfile').change(function() {
  if (window.File && window.FileReader && window.FileList && window.Blob) {
    var reader = new FileReader();
    reader.readAsText(document.getElementById('id_fromfile').files[0]);
    reader.onload = function (evt) {
      $('#id_body_raw').val(evt.target.result);
    };
  } else {
    alert('The File APIs are not fully supported in this browser.');
  }
});
</script>
{% endblock %}
